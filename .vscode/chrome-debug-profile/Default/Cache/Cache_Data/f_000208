import __vite__cjsImport0__sniptt_guards from "/@fs/D:/twenty-table-o/node_modules/.vite/packages/twenty-front/deps/@sniptt_guards.js?v=226f7286"; const isNonEmptyString = __vite__cjsImport0__sniptt_guards["isNonEmptyString"];
import { triggerUpdateRelationsOptimisticEffect } from "/src/modules/apollo/optimistic-effect/utils/triggerUpdateRelationsOptimisticEffect.ts";
import { getEdgeTypename } from "/src/modules/object-record/cache/utils/getEdgeTypename.ts";
import { isObjectRecordConnectionWithRefs } from "/src/modules/object-record/cache/utils/isObjectRecordConnectionWithRefs.ts";
import { isRecordMatchingFilter } from "/src/modules/object-record/record-filter/utils/isRecordMatchingFilter.ts";
import { encodeCursor } from "/src/modules/apollo/utils/encodeCursor.ts";
import { getRecordFromCache } from "/src/modules/object-record/cache/utils/getRecordFromCache.ts";
import { getRecordNodeFromRecord } from "/src/modules/object-record/cache/utils/getRecordNodeFromRecord.ts";
import { parseApolloStoreFieldName } from "/src/utils/parseApolloStoreFieldName.ts";
import { isDefined } from "/@fs/D:/twenty-table-o/packages/twenty-shared/utils/dist/twenty-shared-utils.esm.js";
export const triggerCreateRecordsOptimisticEffect = ({ cache, objectMetadataItem, recordsToCreate, objectMetadataItems, shouldMatchRootQueryFilter, checkForRecordInCache = false })=>{
    const getRecordNodeFromCache = (recordId)=>{
        const cachedRecord = getRecordFromCache({
            cache,
            objectMetadataItem,
            objectMetadataItems,
            recordId
        });
        return getRecordNodeFromRecord({
            objectMetadataItem,
            objectMetadataItems,
            record: cachedRecord,
            computeReferences: false
        });
    };
    recordsToCreate.forEach((record)=>{
        const currentSourceRecord = checkForRecordInCache ? getRecordNodeFromCache(record.id) : null;
        triggerUpdateRelationsOptimisticEffect({
            cache,
            sourceObjectMetadataItem: objectMetadataItem,
            currentSourceRecord,
            updatedSourceRecord: record,
            objectMetadataItems
        });
    });
    cache.modify({
        broadcast: false,
        fields: {
            [objectMetadataItem.namePlural]: (rootQueryCachedResponse, { DELETE: _DELETE, readField, storeFieldName, toReference })=>{
                const shouldSkip = !isObjectRecordConnectionWithRefs(objectMetadataItem.nameSingular, rootQueryCachedResponse);
                if (shouldSkip) {
                    return rootQueryCachedResponse;
                }
                const { fieldVariables: rootQueryVariables } = parseApolloStoreFieldName(storeFieldName);
                const rootQueryFilter = rootQueryVariables?.filter;
                const rootQueryCachedObjectRecordConnection = rootQueryCachedResponse;
                const rootQueryCachedRecordEdges = readField('edges', rootQueryCachedObjectRecordConnection);
                const rootQueryCachedRecordTotalCount = readField('totalCount', rootQueryCachedObjectRecordConnection);
                const rootQueryCachedPageInfo = readField('pageInfo', rootQueryCachedObjectRecordConnection);
                const nextRootQueryCachedRecordEdges = rootQueryCachedRecordEdges ? [
                    ...rootQueryCachedRecordEdges
                ] : [];
                const nextQueryCachedPageInfo = isDefined(rootQueryCachedPageInfo) ? {
                    ...rootQueryCachedPageInfo
                } : {};
                const hasAddedRecords = recordsToCreate.map((recordToCreate)=>{
                    if (isNonEmptyString(recordToCreate.id)) {
                        if (isDefined(rootQueryFilter) && shouldMatchRootQueryFilter === true) {
                            const recordToCreateMatchesThisRootQueryFilter = isRecordMatchingFilter({
                                record: recordToCreate,
                                filter: rootQueryFilter,
                                objectMetadataItem
                            });
                            if (!recordToCreateMatchesThisRootQueryFilter) {
                                return false;
                            }
                        }
                        const recordToCreateReference = toReference(recordToCreate);
                        if (!recordToCreateReference) {
                            throw new Error(`Failed to create reference for record with id: ${recordToCreate.id}`);
                        }
                        const recordAlreadyInCache = rootQueryCachedRecordEdges?.some((cachedEdge)=>{
                            return cache.identify(recordToCreateReference) === cache.identify(cachedEdge.node);
                        });
                        if (recordToCreateReference && !recordAlreadyInCache) {
                            const cursor = encodeCursor(recordToCreate);
                            const edge = {
                                __typename: getEdgeTypename(objectMetadataItem.nameSingular),
                                node: recordToCreateReference,
                                cursor
                            };
                            if (!isDefined(recordToCreate.position) || recordToCreate.position === 'first') {
                                nextRootQueryCachedRecordEdges.unshift(edge);
                                nextQueryCachedPageInfo.startCursor = cursor;
                            } else if (recordToCreate.position === 'last') {
                                nextRootQueryCachedRecordEdges.push(edge);
                                nextQueryCachedPageInfo.endCursor = cursor;
                            } else if (typeof recordToCreate.position === 'number') {
                                let index = Math.round(nextRootQueryCachedRecordEdges.length * recordToCreate.position);
                                if (recordToCreate.position < 0) {
                                    index = Math.max(0, nextRootQueryCachedRecordEdges.length + Math.round(recordToCreate.position));
                                } else if (recordToCreate.position > 1) {
                                    index = nextRootQueryCachedRecordEdges.length;
                                }
                                index = Math.max(0, Math.min(index, nextRootQueryCachedRecordEdges.length));
                                nextRootQueryCachedRecordEdges.splice(index, 0, edge);
                                if (index === 0) {
                                    nextQueryCachedPageInfo.startCursor = cursor;
                                } else if (index === nextRootQueryCachedRecordEdges.length - 1) {
                                    nextQueryCachedPageInfo.endCursor = cursor;
                                }
                            }
                            return true;
                        }
                    }
                    return false;
                }).some((hasAddedRecord)=>hasAddedRecord);
                if (!hasAddedRecords) {
                    return rootQueryCachedObjectRecordConnection;
                }
                return {
                    ...rootQueryCachedObjectRecordConnection,
                    edges: nextRootQueryCachedRecordEdges,
                    totalCount: isDefined(rootQueryCachedRecordTotalCount) ? rootQueryCachedRecordTotalCount + 1 : undefined,
                    pageInfo: nextQueryCachedPageInfo
                };
            }
        }
    });
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRyaWdnZXJDcmVhdGVSZWNvcmRzT3B0aW1pc3RpY0VmZmVjdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcG9sbG9DYWNoZSwgU3RvcmVPYmplY3QgfSBmcm9tICdAYXBvbGxvL2NsaWVudCc7XG5pbXBvcnQgeyBpc05vbkVtcHR5U3RyaW5nIH0gZnJvbSAnQHNuaXB0dC9ndWFyZHMnO1xuXG5pbXBvcnQgeyB0cmlnZ2VyVXBkYXRlUmVsYXRpb25zT3B0aW1pc3RpY0VmZmVjdCB9IGZyb20gJ0AvYXBvbGxvL29wdGltaXN0aWMtZWZmZWN0L3V0aWxzL3RyaWdnZXJVcGRhdGVSZWxhdGlvbnNPcHRpbWlzdGljRWZmZWN0JztcbmltcG9ydCB7IE9iamVjdE1ldGFkYXRhSXRlbSB9IGZyb20gJ0Avb2JqZWN0LW1ldGFkYXRhL3R5cGVzL09iamVjdE1ldGFkYXRhSXRlbSc7XG5pbXBvcnQgeyBSZWNvcmRHcWxSZWZFZGdlIH0gZnJvbSAnQC9vYmplY3QtcmVjb3JkL2NhY2hlL3R5cGVzL1JlY29yZEdxbFJlZkVkZ2UnO1xuaW1wb3J0IHsgZ2V0RWRnZVR5cGVuYW1lIH0gZnJvbSAnQC9vYmplY3QtcmVjb3JkL2NhY2hlL3V0aWxzL2dldEVkZ2VUeXBlbmFtZSc7XG5pbXBvcnQgeyBpc09iamVjdFJlY29yZENvbm5lY3Rpb25XaXRoUmVmcyB9IGZyb20gJ0Avb2JqZWN0LXJlY29yZC9jYWNoZS91dGlscy9pc09iamVjdFJlY29yZENvbm5lY3Rpb25XaXRoUmVmcyc7XG5pbXBvcnQgeyBSZWNvcmRHcWxOb2RlIH0gZnJvbSAnQC9vYmplY3QtcmVjb3JkL2dyYXBocWwvdHlwZXMvUmVjb3JkR3FsTm9kZSc7XG5pbXBvcnQgeyBpc1JlY29yZE1hdGNoaW5nRmlsdGVyIH0gZnJvbSAnQC9vYmplY3QtcmVjb3JkL3JlY29yZC1maWx0ZXIvdXRpbHMvaXNSZWNvcmRNYXRjaGluZ0ZpbHRlcic7XG5cbmltcG9ydCB7IENhY2hlZE9iamVjdFJlY29yZFF1ZXJ5VmFyaWFibGVzIH0gZnJvbSAnQC9hcG9sbG8vdHlwZXMvQ2FjaGVkT2JqZWN0UmVjb3JkUXVlcnlWYXJpYWJsZXMnO1xuaW1wb3J0IHsgZW5jb2RlQ3Vyc29yIH0gZnJvbSAnQC9hcG9sbG8vdXRpbHMvZW5jb2RlQ3Vyc29yJztcbmltcG9ydCB7IGdldFJlY29yZEZyb21DYWNoZSB9IGZyb20gJ0Avb2JqZWN0LXJlY29yZC9jYWNoZS91dGlscy9nZXRSZWNvcmRGcm9tQ2FjaGUnO1xuaW1wb3J0IHsgZ2V0UmVjb3JkTm9kZUZyb21SZWNvcmQgfSBmcm9tICdAL29iamVjdC1yZWNvcmQvY2FjaGUvdXRpbHMvZ2V0UmVjb3JkTm9kZUZyb21SZWNvcmQnO1xuaW1wb3J0IHsgcGFyc2VBcG9sbG9TdG9yZUZpZWxkTmFtZSB9IGZyb20gJ34vdXRpbHMvcGFyc2VBcG9sbG9TdG9yZUZpZWxkTmFtZSc7XG5pbXBvcnQgeyBpc0RlZmluZWQgfSBmcm9tICd0d2VudHktc2hhcmVkL3V0aWxzJztcblxuLypcbiAgVE9ETzogZm9yIG5vdyBuZXcgcmVjb3JkcyBhcmUgYWRkZWQgdG8gYWxsIGNhY2hlZCByZWNvcmQgbGlzdHMsIG5vIG1hdHRlciB3aGF0IHRoZSB2YXJpYWJsZXMgKGZpbHRlcnMsIG9yZGVyQnksIGV0Yy4pIGFyZS5cbiAgV2UgbmVlZCB0byByZWZhY3RvciBob3cgdGhlIHJlY29yZCBjcmVhdGlvbiB3b3JrcyBpbiB0aGUgUmVjb3JkVGFibGUgc28gdGhlIGNyZWF0ZWQgcmVjb3JkIHJvdyBpcyB0ZW1wb3JhcmlseSBkaXNwbGF5ZWQgd2l0aCBhIGxvY2FsIHN0YXRlLFxuICB0aGVuIHdlJ2xsIGJlIGFibGUgdG8gdW5jb21tZW50IHRoZSBjb2RlIGJlbG93IHNvIHRoZSBjYWNoZWQgbGlzdHMgYXJlIHVwZGF0ZWQgY29oZXJlbnRseSB3aXRoIHRoZSB2YXJpYWJsZXMuXG4qL1xudHlwZSBUcmlnZ2VyQ3JlYXRlUmVjb3Jkc09wdGltaXN0aWNFZmZlY3RBcmdzID0ge1xuICBjYWNoZTogQXBvbGxvQ2FjaGU8b2JqZWN0PjtcbiAgb2JqZWN0TWV0YWRhdGFJdGVtOiBPYmplY3RNZXRhZGF0YUl0ZW07XG4gIHJlY29yZHNUb0NyZWF0ZTogUmVjb3JkR3FsTm9kZVtdO1xuICBvYmplY3RNZXRhZGF0YUl0ZW1zOiBPYmplY3RNZXRhZGF0YUl0ZW1bXTtcbiAgc2hvdWxkTWF0Y2hSb290UXVlcnlGaWx0ZXI/OiBib29sZWFuO1xuICBjaGVja0ZvclJlY29yZEluQ2FjaGU/OiBib29sZWFuO1xufTtcbmV4cG9ydCBjb25zdCB0cmlnZ2VyQ3JlYXRlUmVjb3Jkc09wdGltaXN0aWNFZmZlY3QgPSAoe1xuICBjYWNoZSxcbiAgb2JqZWN0TWV0YWRhdGFJdGVtLFxuICByZWNvcmRzVG9DcmVhdGUsXG4gIG9iamVjdE1ldGFkYXRhSXRlbXMsXG4gIHNob3VsZE1hdGNoUm9vdFF1ZXJ5RmlsdGVyLFxuICBjaGVja0ZvclJlY29yZEluQ2FjaGUgPSBmYWxzZSxcbn06IFRyaWdnZXJDcmVhdGVSZWNvcmRzT3B0aW1pc3RpY0VmZmVjdEFyZ3MpID0+IHtcbiAgY29uc3QgZ2V0UmVjb3JkTm9kZUZyb21DYWNoZSA9IChyZWNvcmRJZDogc3RyaW5nKTogUmVjb3JkR3FsTm9kZSB8IG51bGwgPT4ge1xuICAgIGNvbnN0IGNhY2hlZFJlY29yZCA9IGdldFJlY29yZEZyb21DYWNoZSh7XG4gICAgICBjYWNoZSxcbiAgICAgIG9iamVjdE1ldGFkYXRhSXRlbSxcbiAgICAgIG9iamVjdE1ldGFkYXRhSXRlbXMsXG4gICAgICByZWNvcmRJZCxcbiAgICB9KTtcbiAgICByZXR1cm4gZ2V0UmVjb3JkTm9kZUZyb21SZWNvcmQoe1xuICAgICAgb2JqZWN0TWV0YWRhdGFJdGVtLFxuICAgICAgb2JqZWN0TWV0YWRhdGFJdGVtcyxcbiAgICAgIHJlY29yZDogY2FjaGVkUmVjb3JkLFxuICAgICAgY29tcHV0ZVJlZmVyZW5jZXM6IGZhbHNlLFxuICAgIH0pO1xuICB9O1xuXG4gIHJlY29yZHNUb0NyZWF0ZS5mb3JFYWNoKChyZWNvcmQpID0+IHtcbiAgICBjb25zdCBjdXJyZW50U291cmNlUmVjb3JkID0gY2hlY2tGb3JSZWNvcmRJbkNhY2hlXG4gICAgICA/IGdldFJlY29yZE5vZGVGcm9tQ2FjaGUocmVjb3JkLmlkKVxuICAgICAgOiBudWxsO1xuICAgIHRyaWdnZXJVcGRhdGVSZWxhdGlvbnNPcHRpbWlzdGljRWZmZWN0KHtcbiAgICAgIGNhY2hlLFxuICAgICAgc291cmNlT2JqZWN0TWV0YWRhdGFJdGVtOiBvYmplY3RNZXRhZGF0YUl0ZW0sXG4gICAgICBjdXJyZW50U291cmNlUmVjb3JkLFxuICAgICAgdXBkYXRlZFNvdXJjZVJlY29yZDogcmVjb3JkLFxuICAgICAgb2JqZWN0TWV0YWRhdGFJdGVtcyxcbiAgICB9KTtcbiAgfSk7XG5cbiAgY2FjaGUubW9kaWZ5PFN0b3JlT2JqZWN0Pih7XG4gICAgYnJvYWRjYXN0OiBmYWxzZSxcbiAgICBmaWVsZHM6IHtcbiAgICAgIFtvYmplY3RNZXRhZGF0YUl0ZW0ubmFtZVBsdXJhbF06IChcbiAgICAgICAgcm9vdFF1ZXJ5Q2FjaGVkUmVzcG9uc2UsXG4gICAgICAgIHsgREVMRVRFOiBfREVMRVRFLCByZWFkRmllbGQsIHN0b3JlRmllbGROYW1lLCB0b1JlZmVyZW5jZSB9LFxuICAgICAgKSA9PiB7XG4gICAgICAgIGNvbnN0IHNob3VsZFNraXAgPSAhaXNPYmplY3RSZWNvcmRDb25uZWN0aW9uV2l0aFJlZnMoXG4gICAgICAgICAgb2JqZWN0TWV0YWRhdGFJdGVtLm5hbWVTaW5ndWxhcixcbiAgICAgICAgICByb290UXVlcnlDYWNoZWRSZXNwb25zZSxcbiAgICAgICAgKTtcblxuICAgICAgICBpZiAoc2hvdWxkU2tpcCkge1xuICAgICAgICAgIHJldHVybiByb290UXVlcnlDYWNoZWRSZXNwb25zZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHsgZmllbGRWYXJpYWJsZXM6IHJvb3RRdWVyeVZhcmlhYmxlcyB9ID1cbiAgICAgICAgICBwYXJzZUFwb2xsb1N0b3JlRmllbGROYW1lPENhY2hlZE9iamVjdFJlY29yZFF1ZXJ5VmFyaWFibGVzPihcbiAgICAgICAgICAgIHN0b3JlRmllbGROYW1lLFxuICAgICAgICAgICk7XG5cbiAgICAgICAgY29uc3Qgcm9vdFF1ZXJ5RmlsdGVyID0gcm9vdFF1ZXJ5VmFyaWFibGVzPy5maWx0ZXI7XG5cbiAgICAgICAgY29uc3Qgcm9vdFF1ZXJ5Q2FjaGVkT2JqZWN0UmVjb3JkQ29ubmVjdGlvbiA9IHJvb3RRdWVyeUNhY2hlZFJlc3BvbnNlO1xuXG4gICAgICAgIGNvbnN0IHJvb3RRdWVyeUNhY2hlZFJlY29yZEVkZ2VzID0gcmVhZEZpZWxkPFJlY29yZEdxbFJlZkVkZ2VbXT4oXG4gICAgICAgICAgJ2VkZ2VzJyxcbiAgICAgICAgICByb290UXVlcnlDYWNoZWRPYmplY3RSZWNvcmRDb25uZWN0aW9uLFxuICAgICAgICApO1xuXG4gICAgICAgIGNvbnN0IHJvb3RRdWVyeUNhY2hlZFJlY29yZFRvdGFsQ291bnQgPSByZWFkRmllbGQ8bnVtYmVyIHwgdW5kZWZpbmVkPihcbiAgICAgICAgICAndG90YWxDb3VudCcsXG4gICAgICAgICAgcm9vdFF1ZXJ5Q2FjaGVkT2JqZWN0UmVjb3JkQ29ubmVjdGlvbixcbiAgICAgICAgKTtcblxuICAgICAgICBjb25zdCByb290UXVlcnlDYWNoZWRQYWdlSW5mbyA9IHJlYWRGaWVsZDx7XG4gICAgICAgICAgc3RhcnRDdXJzb3I/OiBzdHJpbmc7XG4gICAgICAgICAgZW5kQ3Vyc29yPzogc3RyaW5nO1xuICAgICAgICAgIGhhc05leHRQYWdlPzogYm9vbGVhbjtcbiAgICAgICAgICBoYXNQcmV2aW91c1BhZ2U/OiBib29sZWFuO1xuICAgICAgICB9PigncGFnZUluZm8nLCByb290UXVlcnlDYWNoZWRPYmplY3RSZWNvcmRDb25uZWN0aW9uKTtcblxuICAgICAgICBjb25zdCBuZXh0Um9vdFF1ZXJ5Q2FjaGVkUmVjb3JkRWRnZXMgPSByb290UXVlcnlDYWNoZWRSZWNvcmRFZGdlc1xuICAgICAgICAgID8gWy4uLnJvb3RRdWVyeUNhY2hlZFJlY29yZEVkZ2VzXVxuICAgICAgICAgIDogW107XG5cbiAgICAgICAgY29uc3QgbmV4dFF1ZXJ5Q2FjaGVkUGFnZUluZm8gPSBpc0RlZmluZWQocm9vdFF1ZXJ5Q2FjaGVkUGFnZUluZm8pXG4gICAgICAgICAgPyB7IC4uLnJvb3RRdWVyeUNhY2hlZFBhZ2VJbmZvIH1cbiAgICAgICAgICA6IHt9O1xuXG4gICAgICAgIGNvbnN0IGhhc0FkZGVkUmVjb3JkcyA9IHJlY29yZHNUb0NyZWF0ZVxuICAgICAgICAgIC5tYXAoKHJlY29yZFRvQ3JlYXRlKSA9PiB7XG4gICAgICAgICAgICBpZiAoaXNOb25FbXB0eVN0cmluZyhyZWNvcmRUb0NyZWF0ZS5pZCkpIHtcbiAgICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgIGlzRGVmaW5lZChyb290UXVlcnlGaWx0ZXIpICYmXG4gICAgICAgICAgICAgICAgc2hvdWxkTWF0Y2hSb290UXVlcnlGaWx0ZXIgPT09IHRydWVcbiAgICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVjb3JkVG9DcmVhdGVNYXRjaGVzVGhpc1Jvb3RRdWVyeUZpbHRlciA9XG4gICAgICAgICAgICAgICAgICBpc1JlY29yZE1hdGNoaW5nRmlsdGVyKHtcbiAgICAgICAgICAgICAgICAgICAgcmVjb3JkOiByZWNvcmRUb0NyZWF0ZSxcbiAgICAgICAgICAgICAgICAgICAgZmlsdGVyOiByb290UXVlcnlGaWx0ZXIsXG4gICAgICAgICAgICAgICAgICAgIG9iamVjdE1ldGFkYXRhSXRlbSxcbiAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgaWYgKCFyZWNvcmRUb0NyZWF0ZU1hdGNoZXNUaGlzUm9vdFF1ZXJ5RmlsdGVyKSB7XG4gICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgY29uc3QgcmVjb3JkVG9DcmVhdGVSZWZlcmVuY2UgPSB0b1JlZmVyZW5jZShyZWNvcmRUb0NyZWF0ZSk7XG5cbiAgICAgICAgICAgICAgaWYgKCFyZWNvcmRUb0NyZWF0ZVJlZmVyZW5jZSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgICAgICAgIGBGYWlsZWQgdG8gY3JlYXRlIHJlZmVyZW5jZSBmb3IgcmVjb3JkIHdpdGggaWQ6ICR7cmVjb3JkVG9DcmVhdGUuaWR9YCxcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgY29uc3QgcmVjb3JkQWxyZWFkeUluQ2FjaGUgPSByb290UXVlcnlDYWNoZWRSZWNvcmRFZGdlcz8uc29tZShcbiAgICAgICAgICAgICAgICAoY2FjaGVkRWRnZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICAgICAgY2FjaGUuaWRlbnRpZnkocmVjb3JkVG9DcmVhdGVSZWZlcmVuY2UpID09PVxuICAgICAgICAgICAgICAgICAgICBjYWNoZS5pZGVudGlmeShjYWNoZWRFZGdlLm5vZGUpXG4gICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgICAgaWYgKHJlY29yZFRvQ3JlYXRlUmVmZXJlbmNlICYmICFyZWNvcmRBbHJlYWR5SW5DYWNoZSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGN1cnNvciA9IGVuY29kZUN1cnNvcihyZWNvcmRUb0NyZWF0ZSk7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBlZGdlID0ge1xuICAgICAgICAgICAgICAgICAgX190eXBlbmFtZTogZ2V0RWRnZVR5cGVuYW1lKG9iamVjdE1ldGFkYXRhSXRlbS5uYW1lU2luZ3VsYXIpLFxuICAgICAgICAgICAgICAgICAgbm9kZTogcmVjb3JkVG9DcmVhdGVSZWZlcmVuY2UsXG4gICAgICAgICAgICAgICAgICBjdXJzb3IsXG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICAgICFpc0RlZmluZWQocmVjb3JkVG9DcmVhdGUucG9zaXRpb24pIHx8XG4gICAgICAgICAgICAgICAgICByZWNvcmRUb0NyZWF0ZS5wb3NpdGlvbiA9PT0gJ2ZpcnN0J1xuICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgbmV4dFJvb3RRdWVyeUNhY2hlZFJlY29yZEVkZ2VzLnVuc2hpZnQoZWRnZSk7XG4gICAgICAgICAgICAgICAgICBuZXh0UXVlcnlDYWNoZWRQYWdlSW5mby5zdGFydEN1cnNvciA9IGN1cnNvcjtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJlY29yZFRvQ3JlYXRlLnBvc2l0aW9uID09PSAnbGFzdCcpIHtcbiAgICAgICAgICAgICAgICAgIG5leHRSb290UXVlcnlDYWNoZWRSZWNvcmRFZGdlcy5wdXNoKGVkZ2UpO1xuICAgICAgICAgICAgICAgICAgbmV4dFF1ZXJ5Q2FjaGVkUGFnZUluZm8uZW5kQ3Vyc29yID0gY3Vyc29yO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHJlY29yZFRvQ3JlYXRlLnBvc2l0aW9uID09PSAnbnVtYmVyJykge1xuICAgICAgICAgICAgICAgICAgbGV0IGluZGV4ID0gTWF0aC5yb3VuZChcbiAgICAgICAgICAgICAgICAgICAgbmV4dFJvb3RRdWVyeUNhY2hlZFJlY29yZEVkZ2VzLmxlbmd0aCAqXG4gICAgICAgICAgICAgICAgICAgICAgcmVjb3JkVG9DcmVhdGUucG9zaXRpb24sXG4gICAgICAgICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAgICAgICBpZiAocmVjb3JkVG9DcmVhdGUucG9zaXRpb24gPCAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGluZGV4ID0gTWF0aC5tYXgoXG4gICAgICAgICAgICAgICAgICAgICAgMCxcbiAgICAgICAgICAgICAgICAgICAgICBuZXh0Um9vdFF1ZXJ5Q2FjaGVkUmVjb3JkRWRnZXMubGVuZ3RoICtcbiAgICAgICAgICAgICAgICAgICAgICAgIE1hdGgucm91bmQocmVjb3JkVG9DcmVhdGUucG9zaXRpb24pLFxuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChyZWNvcmRUb0NyZWF0ZS5wb3NpdGlvbiA+IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgaW5kZXggPSBuZXh0Um9vdFF1ZXJ5Q2FjaGVkUmVjb3JkRWRnZXMubGVuZ3RoO1xuICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICBpbmRleCA9IE1hdGgubWF4KFxuICAgICAgICAgICAgICAgICAgICAwLFxuICAgICAgICAgICAgICAgICAgICBNYXRoLm1pbihpbmRleCwgbmV4dFJvb3RRdWVyeUNhY2hlZFJlY29yZEVkZ2VzLmxlbmd0aCksXG4gICAgICAgICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAgICAgICBuZXh0Um9vdFF1ZXJ5Q2FjaGVkUmVjb3JkRWRnZXMuc3BsaWNlKGluZGV4LCAwLCBlZGdlKTtcblxuICAgICAgICAgICAgICAgICAgaWYgKGluZGV4ID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIG5leHRRdWVyeUNhY2hlZFBhZ2VJbmZvLnN0YXJ0Q3Vyc29yID0gY3Vyc29yO1xuICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChcbiAgICAgICAgICAgICAgICAgICAgaW5kZXggPT09XG4gICAgICAgICAgICAgICAgICAgIG5leHRSb290UXVlcnlDYWNoZWRSZWNvcmRFZGdlcy5sZW5ndGggLSAxXG4gICAgICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICAgICAgbmV4dFF1ZXJ5Q2FjaGVkUGFnZUluZm8uZW5kQ3Vyc29yID0gY3Vyc29yO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICB9KVxuICAgICAgICAgIC5zb21lKChoYXNBZGRlZFJlY29yZCkgPT4gaGFzQWRkZWRSZWNvcmQpO1xuXG4gICAgICAgIGlmICghaGFzQWRkZWRSZWNvcmRzKSB7XG4gICAgICAgICAgcmV0dXJuIHJvb3RRdWVyeUNhY2hlZE9iamVjdFJlY29yZENvbm5lY3Rpb247XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIC4uLnJvb3RRdWVyeUNhY2hlZE9iamVjdFJlY29yZENvbm5lY3Rpb24sXG4gICAgICAgICAgZWRnZXM6IG5leHRSb290UXVlcnlDYWNoZWRSZWNvcmRFZGdlcyxcbiAgICAgICAgICB0b3RhbENvdW50OiBpc0RlZmluZWQocm9vdFF1ZXJ5Q2FjaGVkUmVjb3JkVG90YWxDb3VudClcbiAgICAgICAgICAgID8gcm9vdFF1ZXJ5Q2FjaGVkUmVjb3JkVG90YWxDb3VudCArIDFcbiAgICAgICAgICAgIDogdW5kZWZpbmVkLFxuICAgICAgICAgIHBhZ2VJbmZvOiBuZXh0UXVlcnlDYWNoZWRQYWdlSW5mbyxcbiAgICAgICAgfTtcbiAgICAgIH0sXG4gICAgfSxcbiAgfSk7XG59O1xuIl0sIm5hbWVzIjpbImlzTm9uRW1wdHlTdHJpbmciLCJ0cmlnZ2VyVXBkYXRlUmVsYXRpb25zT3B0aW1pc3RpY0VmZmVjdCIsImdldEVkZ2VUeXBlbmFtZSIsImlzT2JqZWN0UmVjb3JkQ29ubmVjdGlvbldpdGhSZWZzIiwiaXNSZWNvcmRNYXRjaGluZ0ZpbHRlciIsImVuY29kZUN1cnNvciIsImdldFJlY29yZEZyb21DYWNoZSIsImdldFJlY29yZE5vZGVGcm9tUmVjb3JkIiwicGFyc2VBcG9sbG9TdG9yZUZpZWxkTmFtZSIsImlzRGVmaW5lZCIsInRyaWdnZXJDcmVhdGVSZWNvcmRzT3B0aW1pc3RpY0VmZmVjdCIsImNhY2hlIiwib2JqZWN0TWV0YWRhdGFJdGVtIiwicmVjb3Jkc1RvQ3JlYXRlIiwib2JqZWN0TWV0YWRhdGFJdGVtcyIsInNob3VsZE1hdGNoUm9vdFF1ZXJ5RmlsdGVyIiwiY2hlY2tGb3JSZWNvcmRJbkNhY2hlIiwiZ2V0UmVjb3JkTm9kZUZyb21DYWNoZSIsInJlY29yZElkIiwiY2FjaGVkUmVjb3JkIiwicmVjb3JkIiwiY29tcHV0ZVJlZmVyZW5jZXMiLCJmb3JFYWNoIiwiY3VycmVudFNvdXJjZVJlY29yZCIsImlkIiwic291cmNlT2JqZWN0TWV0YWRhdGFJdGVtIiwidXBkYXRlZFNvdXJjZVJlY29yZCIsIm1vZGlmeSIsImJyb2FkY2FzdCIsImZpZWxkcyIsIm5hbWVQbHVyYWwiLCJyb290UXVlcnlDYWNoZWRSZXNwb25zZSIsIkRFTEVURSIsIl9ERUxFVEUiLCJyZWFkRmllbGQiLCJzdG9yZUZpZWxkTmFtZSIsInRvUmVmZXJlbmNlIiwic2hvdWxkU2tpcCIsIm5hbWVTaW5ndWxhciIsImZpZWxkVmFyaWFibGVzIiwicm9vdFF1ZXJ5VmFyaWFibGVzIiwicm9vdFF1ZXJ5RmlsdGVyIiwiZmlsdGVyIiwicm9vdFF1ZXJ5Q2FjaGVkT2JqZWN0UmVjb3JkQ29ubmVjdGlvbiIsInJvb3RRdWVyeUNhY2hlZFJlY29yZEVkZ2VzIiwicm9vdFF1ZXJ5Q2FjaGVkUmVjb3JkVG90YWxDb3VudCIsInJvb3RRdWVyeUNhY2hlZFBhZ2VJbmZvIiwibmV4dFJvb3RRdWVyeUNhY2hlZFJlY29yZEVkZ2VzIiwibmV4dFF1ZXJ5Q2FjaGVkUGFnZUluZm8iLCJoYXNBZGRlZFJlY29yZHMiLCJtYXAiLCJyZWNvcmRUb0NyZWF0ZSIsInJlY29yZFRvQ3JlYXRlTWF0Y2hlc1RoaXNSb290UXVlcnlGaWx0ZXIiLCJyZWNvcmRUb0NyZWF0ZVJlZmVyZW5jZSIsIkVycm9yIiwicmVjb3JkQWxyZWFkeUluQ2FjaGUiLCJzb21lIiwiY2FjaGVkRWRnZSIsImlkZW50aWZ5Iiwibm9kZSIsImN1cnNvciIsImVkZ2UiLCJfX3R5cGVuYW1lIiwicG9zaXRpb24iLCJ1bnNoaWZ0Iiwic3RhcnRDdXJzb3IiLCJwdXNoIiwiZW5kQ3Vyc29yIiwiaW5kZXgiLCJNYXRoIiwicm91bmQiLCJsZW5ndGgiLCJtYXgiLCJtaW4iLCJzcGxpY2UiLCJoYXNBZGRlZFJlY29yZCIsImVkZ2VzIiwidG90YWxDb3VudCIsInVuZGVmaW5lZCIsInBhZ2VJbmZvIl0sIm1hcHBpbmdzIjoiQUFDQSxTQUFTQSxnQkFBZ0IsUUFBUSxpQkFBaUI7QUFFbEQsU0FBU0Msc0NBQXNDLFFBQVEsMEVBQTBFO0FBR2pJLFNBQVNDLGVBQWUsUUFBUSw4Q0FBOEM7QUFDOUUsU0FBU0MsZ0NBQWdDLFFBQVEsK0RBQStEO0FBRWhILFNBQVNDLHNCQUFzQixRQUFRLDZEQUE2RDtBQUdwRyxTQUFTQyxZQUFZLFFBQVEsOEJBQThCO0FBQzNELFNBQVNDLGtCQUFrQixRQUFRLGlEQUFpRDtBQUNwRixTQUFTQyx1QkFBdUIsUUFBUSxzREFBc0Q7QUFDOUYsU0FBU0MseUJBQXlCLFFBQVEsb0NBQW9DO0FBQzlFLFNBQVNDLFNBQVMsUUFBUSxzQkFBc0I7QUFlaEQsT0FBTyxNQUFNQyx1Q0FBdUMsQ0FBQyxFQUNuREMsS0FBSyxFQUNMQyxrQkFBa0IsRUFDbEJDLGVBQWUsRUFDZkMsbUJBQW1CLEVBQ25CQywwQkFBMEIsRUFDMUJDLHdCQUF3QixLQUFLLEVBQ1k7SUFDekMsTUFBTUMseUJBQXlCLENBQUNDO1FBQzlCLE1BQU1DLGVBQWViLG1CQUFtQjtZQUN0Q0s7WUFDQUM7WUFDQUU7WUFDQUk7UUFDRjtRQUNBLE9BQU9YLHdCQUF3QjtZQUM3Qks7WUFDQUU7WUFDQU0sUUFBUUQ7WUFDUkUsbUJBQW1CO1FBQ3JCO0lBQ0Y7SUFFQVIsZ0JBQWdCUyxPQUFPLENBQUMsQ0FBQ0Y7UUFDdkIsTUFBTUcsc0JBQXNCUCx3QkFDeEJDLHVCQUF1QkcsT0FBT0ksRUFBRSxJQUNoQztRQUNKdkIsdUNBQXVDO1lBQ3JDVTtZQUNBYywwQkFBMEJiO1lBQzFCVztZQUNBRyxxQkFBcUJOO1lBQ3JCTjtRQUNGO0lBQ0Y7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