import { useRecoilCallback, useSetRecoilState } from "/@fs/D:/twenty-table-o/node_modules/.vite/packages/twenty-front/deps/recoil.js?v=226f7286";
import { useInitDraftValueV2 } from "/src/modules/object-record/record-field/hooks/useInitDraftValueV2.ts";
import { isFieldValueEmpty } from "/src/modules/object-record/record-field/utils/isFieldValueEmpty.ts";
import { viewableRecordIdState } from "/src/modules/object-record/record-right-drawer/states/viewableRecordIdState.ts";
import { recordStoreFamilySelector } from "/src/modules/object-record/record-store/states/selectors/recordStoreFamilySelector.ts";
import { SOFT_FOCUS_CLICK_OUTSIDE_LISTENER_ID } from "/src/modules/object-record/record-table/constants/SoftFocusClickOutsideListenerId.ts";
import { useLeaveTableFocus } from "/src/modules/object-record/record-table/hooks/internal/useLeaveTableFocus.ts";
import { useMoveEditModeToTableCellPosition } from "/src/modules/object-record/record-table/hooks/internal/useMoveEditModeToCellPosition.ts";
import { useDragSelect } from "/src/modules/ui/utilities/drag-select/hooks/useDragSelect.ts";
import { useSetHotkeyScope } from "/src/modules/ui/utilities/hotkey/hooks/useSetHotkeyScope.ts";
import { useClickOutsideListener } from "/src/modules/ui/utilities/pointer-event/hooks/useClickOutsideListener.ts";
import { getSnapshotValue } from "/src/modules/ui/utilities/state/utils/getSnapshotValue.ts";
import { useOpenRecordInCommandMenu } from "/src/modules/command-menu/hooks/useOpenRecordInCommandMenu.ts";
import { useOpenFieldInputEditMode } from "/src/modules/object-record/record-field/hooks/useOpenFieldInputEditMode.ts";
import { useRecordIndexContextOrThrow } from "/src/modules/object-record/record-index/contexts/RecordIndexContext.ts";
import { recordIndexOpenRecordInState } from "/src/modules/object-record/record-index/states/recordIndexOpenRecordInState.ts";
import { viewableRecordNameSingularState } from "/src/modules/object-record/record-right-drawer/states/viewableRecordNameSingularState.ts";
import { RECORD_TABLE_CLICK_OUTSIDE_LISTENER_ID } from "/src/modules/object-record/record-table/constants/RecordTableClickOutsideListenerId.ts";
import { getDropdownFocusIdForRecordField } from "/src/modules/object-record/utils/getDropdownFocusIdForRecordField.ts";
import { getRecordFieldInputId } from "/src/modules/object-record/utils/getRecordFieldInputId.ts";
import { useSetActiveDropdownFocusIdAndMemorizePrevious } from "/src/modules/ui/layout/dropdown/hooks/useSetFocusedDropdownIdAndMemorizePrevious.ts";
import { useClickOustideListenerStates } from "/src/modules/ui/utilities/pointer-event/hooks/useClickOustideListenerStates.ts";
import { ViewOpenRecordInType } from "/src/modules/views/types/ViewOpenRecordInType.ts";
import { useNavigate } from "/@fs/D:/twenty-table-o/node_modules/.vite/packages/twenty-front/deps/react-router-dom.js?v=226f7286";
import { isDefined } from "/@fs/D:/twenty-table-o/packages/twenty-shared/utils/dist/twenty-shared-utils.esm.js";
import { TableHotkeyScope } from "/src/modules/object-record/record-table/types/TableHotkeyScope.ts";
export const DEFAULT_CELL_SCOPE = {
    scope: TableHotkeyScope.CellEditMode
};
export const useOpenRecordTableCellV2 = (tableScopeId)=>{
    const { getClickOutsideListenerIsActivatedState } = useClickOustideListenerStates(RECORD_TABLE_CLICK_OUTSIDE_LISTENER_ID);
    const { indexIdentifierUrl } = useRecordIndexContextOrThrow();
    const moveEditModeToTableCellPosition = useMoveEditModeToTableCellPosition(tableScopeId);
    const setHotkeyScope = useSetHotkeyScope();
    const { setDragSelectionStartEnabled } = useDragSelect();
    const leaveTableFocus = useLeaveTableFocus(tableScopeId);
    const { toggleClickOutsideListener } = useClickOutsideListener(SOFT_FOCUS_CLICK_OUTSIDE_LISTENER_ID);
    const initDraftValue = useInitDraftValueV2();
    const setViewableRecordId = useSetRecoilState(viewableRecordIdState);
    const setViewableRecordNameSingular = useSetRecoilState(viewableRecordNameSingularState);
    const navigate = useNavigate();
    const { setActiveDropdownFocusIdAndMemorizePrevious } = useSetActiveDropdownFocusIdAndMemorizePrevious();
    const { openRecordInCommandMenu } = useOpenRecordInCommandMenu();
    const { openFieldInput } = useOpenFieldInputEditMode();
    const openTableCell = useRecoilCallback(({ snapshot, set })=>({ initialValue, cellPosition, isReadOnly, objectNameSingular, customCellHotkeyScope, fieldDefinition, recordId, isActionButtonClick, isNavigating })=>{
            if (isReadOnly) {
                return;
            }
            set(getClickOutsideListenerIsActivatedState, false);
            const isFirstColumnCell = cellPosition.column === 0;
            const fieldValue = getSnapshotValue(snapshot, recordStoreFamilySelector({
                recordId,
                fieldName: fieldDefinition.metadata.fieldName
            }));
            const isEmpty = isFieldValueEmpty({
                fieldDefinition,
                fieldValue
            });
            if (isFirstColumnCell && !isEmpty && !isActionButtonClick || isNavigating) {
                leaveTableFocus();
                const openRecordIn = snapshot.getLoadable(recordIndexOpenRecordInState).getValue();
                if (openRecordIn === ViewOpenRecordInType.RECORD_PAGE) {
                    navigate(indexIdentifierUrl(recordId));
                }
                if (openRecordIn === ViewOpenRecordInType.SIDE_PANEL) {
                    openRecordInCommandMenu({
                        recordId,
                        objectNameSingular
                    });
                }
                return;
            }
            if (isFirstColumnCell && !isEmpty && isActionButtonClick) {
                leaveTableFocus();
                setViewableRecordId(recordId);
                setViewableRecordNameSingular(objectNameSingular);
                return;
            }
            setDragSelectionStartEnabled(false);
            openFieldInput({
                fieldDefinition,
                recordId
            });
            moveEditModeToTableCellPosition(cellPosition);
            initDraftValue({
                value: initialValue,
                recordId,
                fieldDefinition,
                fieldComponentInstanceId: getRecordFieldInputId(recordId, fieldDefinition.metadata.fieldName, 'record-table-cell')
            });
            toggleClickOutsideListener(false);
            if (isDefined(customCellHotkeyScope)) {
                setHotkeyScope(customCellHotkeyScope.scope, customCellHotkeyScope.customScopes);
            } else {
                setHotkeyScope(DEFAULT_CELL_SCOPE.scope, DEFAULT_CELL_SCOPE.customScopes);
            }
            setActiveDropdownFocusIdAndMemorizePrevious(getDropdownFocusIdForRecordField(recordId, fieldDefinition.fieldMetadataId, 'table-cell'));
        }, [
        getClickOutsideListenerIsActivatedState,
        setDragSelectionStartEnabled,
        openFieldInput,
        moveEditModeToTableCellPosition,
        initDraftValue,
        toggleClickOutsideListener,
        setActiveDropdownFocusIdAndMemorizePrevious,
        leaveTableFocus,
        navigate,
        indexIdentifierUrl,
        openRecordInCommandMenu,
        setViewableRecordId,
        setViewableRecordNameSingular,
        setHotkeyScope
    ]);
    return {
        openTableCell
    };
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInVzZU9wZW5SZWNvcmRUYWJsZUNlbGxWMi50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyB1c2VSZWNvaWxDYWxsYmFjaywgdXNlU2V0UmVjb2lsU3RhdGUgfSBmcm9tICdyZWNvaWwnO1xuXG5pbXBvcnQgeyB1c2VJbml0RHJhZnRWYWx1ZVYyIH0gZnJvbSAnQC9vYmplY3QtcmVjb3JkL3JlY29yZC1maWVsZC9ob29rcy91c2VJbml0RHJhZnRWYWx1ZVYyJztcbmltcG9ydCB7IEZpZWxkRGVmaW5pdGlvbiB9IGZyb20gJ0Avb2JqZWN0LXJlY29yZC9yZWNvcmQtZmllbGQvdHlwZXMvRmllbGREZWZpbml0aW9uJztcbmltcG9ydCB7IEZpZWxkTWV0YWRhdGEgfSBmcm9tICdAL29iamVjdC1yZWNvcmQvcmVjb3JkLWZpZWxkL3R5cGVzL0ZpZWxkTWV0YWRhdGEnO1xuaW1wb3J0IHsgaXNGaWVsZFZhbHVlRW1wdHkgfSBmcm9tICdAL29iamVjdC1yZWNvcmQvcmVjb3JkLWZpZWxkL3V0aWxzL2lzRmllbGRWYWx1ZUVtcHR5JztcbmltcG9ydCB7IHZpZXdhYmxlUmVjb3JkSWRTdGF0ZSB9IGZyb20gJ0Avb2JqZWN0LXJlY29yZC9yZWNvcmQtcmlnaHQtZHJhd2VyL3N0YXRlcy92aWV3YWJsZVJlY29yZElkU3RhdGUnO1xuaW1wb3J0IHsgcmVjb3JkU3RvcmVGYW1pbHlTZWxlY3RvciB9IGZyb20gJ0Avb2JqZWN0LXJlY29yZC9yZWNvcmQtc3RvcmUvc3RhdGVzL3NlbGVjdG9ycy9yZWNvcmRTdG9yZUZhbWlseVNlbGVjdG9yJztcbmltcG9ydCB7IFNPRlRfRk9DVVNfQ0xJQ0tfT1VUU0lERV9MSVNURU5FUl9JRCB9IGZyb20gJ0Avb2JqZWN0LXJlY29yZC9yZWNvcmQtdGFibGUvY29uc3RhbnRzL1NvZnRGb2N1c0NsaWNrT3V0c2lkZUxpc3RlbmVySWQnO1xuaW1wb3J0IHsgdXNlTGVhdmVUYWJsZUZvY3VzIH0gZnJvbSAnQC9vYmplY3QtcmVjb3JkL3JlY29yZC10YWJsZS9ob29rcy9pbnRlcm5hbC91c2VMZWF2ZVRhYmxlRm9jdXMnO1xuaW1wb3J0IHsgdXNlTW92ZUVkaXRNb2RlVG9UYWJsZUNlbGxQb3NpdGlvbiB9IGZyb20gJ0Avb2JqZWN0LXJlY29yZC9yZWNvcmQtdGFibGUvaG9va3MvaW50ZXJuYWwvdXNlTW92ZUVkaXRNb2RlVG9DZWxsUG9zaXRpb24nO1xuaW1wb3J0IHsgVGFibGVDZWxsUG9zaXRpb24gfSBmcm9tICdAL29iamVjdC1yZWNvcmQvcmVjb3JkLXRhYmxlL3R5cGVzL1RhYmxlQ2VsbFBvc2l0aW9uJztcbmltcG9ydCB7IHVzZURyYWdTZWxlY3QgfSBmcm9tICdAL3VpL3V0aWxpdGllcy9kcmFnLXNlbGVjdC9ob29rcy91c2VEcmFnU2VsZWN0JztcbmltcG9ydCB7IHVzZVNldEhvdGtleVNjb3BlIH0gZnJvbSAnQC91aS91dGlsaXRpZXMvaG90a2V5L2hvb2tzL3VzZVNldEhvdGtleVNjb3BlJztcbmltcG9ydCB7IEhvdGtleVNjb3BlIH0gZnJvbSAnQC91aS91dGlsaXRpZXMvaG90a2V5L3R5cGVzL0hvdGtleVNjb3BlJztcbmltcG9ydCB7IHVzZUNsaWNrT3V0c2lkZUxpc3RlbmVyIH0gZnJvbSAnQC91aS91dGlsaXRpZXMvcG9pbnRlci1ldmVudC9ob29rcy91c2VDbGlja091dHNpZGVMaXN0ZW5lcic7XG5pbXBvcnQgeyBnZXRTbmFwc2hvdFZhbHVlIH0gZnJvbSAnQC91aS91dGlsaXRpZXMvc3RhdGUvdXRpbHMvZ2V0U25hcHNob3RWYWx1ZSc7XG5cbmltcG9ydCB7IHVzZU9wZW5SZWNvcmRJbkNvbW1hbmRNZW51IH0gZnJvbSAnQC9jb21tYW5kLW1lbnUvaG9va3MvdXNlT3BlblJlY29yZEluQ29tbWFuZE1lbnUnO1xuaW1wb3J0IHsgdXNlT3BlbkZpZWxkSW5wdXRFZGl0TW9kZSB9IGZyb20gJ0Avb2JqZWN0LXJlY29yZC9yZWNvcmQtZmllbGQvaG9va3MvdXNlT3BlbkZpZWxkSW5wdXRFZGl0TW9kZSc7XG5pbXBvcnQgeyB1c2VSZWNvcmRJbmRleENvbnRleHRPclRocm93IH0gZnJvbSAnQC9vYmplY3QtcmVjb3JkL3JlY29yZC1pbmRleC9jb250ZXh0cy9SZWNvcmRJbmRleENvbnRleHQnO1xuaW1wb3J0IHsgcmVjb3JkSW5kZXhPcGVuUmVjb3JkSW5TdGF0ZSB9IGZyb20gJ0Avb2JqZWN0LXJlY29yZC9yZWNvcmQtaW5kZXgvc3RhdGVzL3JlY29yZEluZGV4T3BlblJlY29yZEluU3RhdGUnO1xuaW1wb3J0IHsgdmlld2FibGVSZWNvcmROYW1lU2luZ3VsYXJTdGF0ZSB9IGZyb20gJ0Avb2JqZWN0LXJlY29yZC9yZWNvcmQtcmlnaHQtZHJhd2VyL3N0YXRlcy92aWV3YWJsZVJlY29yZE5hbWVTaW5ndWxhclN0YXRlJztcbmltcG9ydCB7IFJFQ09SRF9UQUJMRV9DTElDS19PVVRTSURFX0xJU1RFTkVSX0lEIH0gZnJvbSAnQC9vYmplY3QtcmVjb3JkL3JlY29yZC10YWJsZS9jb25zdGFudHMvUmVjb3JkVGFibGVDbGlja091dHNpZGVMaXN0ZW5lcklkJztcbmltcG9ydCB7IGdldERyb3Bkb3duRm9jdXNJZEZvclJlY29yZEZpZWxkIH0gZnJvbSAnQC9vYmplY3QtcmVjb3JkL3V0aWxzL2dldERyb3Bkb3duRm9jdXNJZEZvclJlY29yZEZpZWxkJztcbmltcG9ydCB7IGdldFJlY29yZEZpZWxkSW5wdXRJZCB9IGZyb20gJ0Avb2JqZWN0LXJlY29yZC91dGlscy9nZXRSZWNvcmRGaWVsZElucHV0SWQnO1xuaW1wb3J0IHsgdXNlU2V0QWN0aXZlRHJvcGRvd25Gb2N1c0lkQW5kTWVtb3JpemVQcmV2aW91cyB9IGZyb20gJ0AvdWkvbGF5b3V0L2Ryb3Bkb3duL2hvb2tzL3VzZVNldEZvY3VzZWREcm9wZG93bklkQW5kTWVtb3JpemVQcmV2aW91cyc7XG5pbXBvcnQgeyB1c2VDbGlja091c3RpZGVMaXN0ZW5lclN0YXRlcyB9IGZyb20gJ0AvdWkvdXRpbGl0aWVzL3BvaW50ZXItZXZlbnQvaG9va3MvdXNlQ2xpY2tPdXN0aWRlTGlzdGVuZXJTdGF0ZXMnO1xuaW1wb3J0IHsgVmlld09wZW5SZWNvcmRJblR5cGUgfSBmcm9tICdAL3ZpZXdzL3R5cGVzL1ZpZXdPcGVuUmVjb3JkSW5UeXBlJztcbmltcG9ydCB7IHVzZU5hdmlnYXRlIH0gZnJvbSAncmVhY3Qtcm91dGVyLWRvbSc7XG5pbXBvcnQgeyBpc0RlZmluZWQgfSBmcm9tICd0d2VudHktc2hhcmVkL3V0aWxzJztcbmltcG9ydCB7IFRhYmxlSG90a2V5U2NvcGUgfSBmcm9tICcuLi8uLi90eXBlcy9UYWJsZUhvdGtleVNjb3BlJztcblxuZXhwb3J0IGNvbnN0IERFRkFVTFRfQ0VMTF9TQ09QRTogSG90a2V5U2NvcGUgPSB7XG4gIHNjb3BlOiBUYWJsZUhvdGtleVNjb3BlLkNlbGxFZGl0TW9kZSxcbn07XG5cbmV4cG9ydCB0eXBlIE9wZW5UYWJsZUNlbGxBcmdzID0ge1xuICBpbml0aWFsVmFsdWU/OiBzdHJpbmc7XG4gIGNlbGxQb3NpdGlvbjogVGFibGVDZWxsUG9zaXRpb247XG4gIGlzUmVhZE9ubHk6IGJvb2xlYW47XG4gIHBhdGhUb1Nob3dQYWdlOiBzdHJpbmc7XG4gIG9iamVjdE5hbWVTaW5ndWxhcjogc3RyaW5nO1xuICBjdXN0b21DZWxsSG90a2V5U2NvcGU6IEhvdGtleVNjb3BlIHwgbnVsbDtcbiAgZmllbGREZWZpbml0aW9uOiBGaWVsZERlZmluaXRpb248RmllbGRNZXRhZGF0YT47XG4gIHJlY29yZElkOiBzdHJpbmc7XG4gIGlzQWN0aW9uQnV0dG9uQ2xpY2s6IGJvb2xlYW47XG4gIGlzTmF2aWdhdGluZzogYm9vbGVhbjtcbn07XG5cbmV4cG9ydCBjb25zdCB1c2VPcGVuUmVjb3JkVGFibGVDZWxsVjIgPSAodGFibGVTY29wZUlkOiBzdHJpbmcpID0+IHtcbiAgY29uc3QgeyBnZXRDbGlja091dHNpZGVMaXN0ZW5lcklzQWN0aXZhdGVkU3RhdGUgfSA9XG4gICAgdXNlQ2xpY2tPdXN0aWRlTGlzdGVuZXJTdGF0ZXMoUkVDT1JEX1RBQkxFX0NMSUNLX09VVFNJREVfTElTVEVORVJfSUQpO1xuXG4gIGNvbnN0IHsgaW5kZXhJZGVudGlmaWVyVXJsIH0gPSB1c2VSZWNvcmRJbmRleENvbnRleHRPclRocm93KCk7XG4gIGNvbnN0IG1vdmVFZGl0TW9kZVRvVGFibGVDZWxsUG9zaXRpb24gPVxuICAgIHVzZU1vdmVFZGl0TW9kZVRvVGFibGVDZWxsUG9zaXRpb24odGFibGVTY29wZUlkKTtcblxuICBjb25zdCBzZXRIb3RrZXlTY29wZSA9IHVzZVNldEhvdGtleVNjb3BlKCk7XG4gIGNvbnN0IHsgc2V0RHJhZ1NlbGVjdGlvblN0YXJ0RW5hYmxlZCB9ID0gdXNlRHJhZ1NlbGVjdCgpO1xuXG4gIGNvbnN0IGxlYXZlVGFibGVGb2N1cyA9IHVzZUxlYXZlVGFibGVGb2N1cyh0YWJsZVNjb3BlSWQpO1xuICBjb25zdCB7IHRvZ2dsZUNsaWNrT3V0c2lkZUxpc3RlbmVyIH0gPSB1c2VDbGlja091dHNpZGVMaXN0ZW5lcihcbiAgICBTT0ZUX0ZPQ1VTX0NMSUNLX09VVFNJREVfTElTVEVORVJfSUQsXG4gICk7XG5cbiAgY29uc3QgaW5pdERyYWZ0VmFsdWUgPSB1c2VJbml0RHJhZnRWYWx1ZVYyKCk7XG5cbiAgY29uc3Qgc2V0Vmlld2FibGVSZWNvcmRJZCA9IHVzZVNldFJlY29pbFN0YXRlKHZpZXdhYmxlUmVjb3JkSWRTdGF0ZSk7XG4gIGNvbnN0IHNldFZpZXdhYmxlUmVjb3JkTmFtZVNpbmd1bGFyID0gdXNlU2V0UmVjb2lsU3RhdGUoXG4gICAgdmlld2FibGVSZWNvcmROYW1lU2luZ3VsYXJTdGF0ZSxcbiAgKTtcblxuICBjb25zdCBuYXZpZ2F0ZSA9IHVzZU5hdmlnYXRlKCk7XG5cbiAgY29uc3QgeyBzZXRBY3RpdmVEcm9wZG93bkZvY3VzSWRBbmRNZW1vcml6ZVByZXZpb3VzIH0gPVxuICAgIHVzZVNldEFjdGl2ZURyb3Bkb3duRm9jdXNJZEFuZE1lbW9yaXplUHJldmlvdXMoKTtcblxuICBjb25zdCB7IG9wZW5SZWNvcmRJbkNvbW1hbmRNZW51IH0gPSB1c2VPcGVuUmVjb3JkSW5Db21tYW5kTWVudSgpO1xuXG4gIGNvbnN0IHsgb3BlbkZpZWxkSW5wdXQgfSA9IHVzZU9wZW5GaWVsZElucHV0RWRpdE1vZGUoKTtcblxuICBjb25zdCBvcGVuVGFibGVDZWxsID0gdXNlUmVjb2lsQ2FsbGJhY2soXG4gICAgKHsgc25hcHNob3QsIHNldCB9KSA9PlxuICAgICAgKHtcbiAgICAgICAgaW5pdGlhbFZhbHVlLFxuICAgICAgICBjZWxsUG9zaXRpb24sXG4gICAgICAgIGlzUmVhZE9ubHksXG4gICAgICAgIG9iamVjdE5hbWVTaW5ndWxhcixcbiAgICAgICAgY3VzdG9tQ2VsbEhvdGtleVNjb3BlLFxuICAgICAgICBmaWVsZERlZmluaXRpb24sXG4gICAgICAgIHJlY29yZElkLFxuICAgICAgICBpc0FjdGlvbkJ1dHRvbkNsaWNrLFxuICAgICAgICBpc05hdmlnYXRpbmcsXG4gICAgICB9OiBPcGVuVGFibGVDZWxsQXJncykgPT4ge1xuICAgICAgICBpZiAoaXNSZWFkT25seSkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHNldChnZXRDbGlja091dHNpZGVMaXN0ZW5lcklzQWN0aXZhdGVkU3RhdGUsIGZhbHNlKTtcblxuICAgICAgICBjb25zdCBpc0ZpcnN0Q29sdW1uQ2VsbCA9IGNlbGxQb3NpdGlvbi5jb2x1bW4gPT09IDA7XG5cbiAgICAgICAgY29uc3QgZmllbGRWYWx1ZSA9IGdldFNuYXBzaG90VmFsdWUoXG4gICAgICAgICAgc25hcHNob3QsXG4gICAgICAgICAgcmVjb3JkU3RvcmVGYW1pbHlTZWxlY3Rvcih7XG4gICAgICAgICAgICByZWNvcmRJZCxcbiAgICAgICAgICAgIGZpZWxkTmFtZTogZmllbGREZWZpbml0aW9uLm1ldGFkYXRhLmZpZWxkTmFtZSxcbiAgICAgICAgICB9KSxcbiAgICAgICAgKTtcblxuICAgICAgICBjb25zdCBpc0VtcHR5ID0gaXNGaWVsZFZhbHVlRW1wdHkoe1xuICAgICAgICAgIGZpZWxkRGVmaW5pdGlvbixcbiAgICAgICAgICBmaWVsZFZhbHVlLFxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoXG4gICAgICAgICAgKGlzRmlyc3RDb2x1bW5DZWxsICYmICFpc0VtcHR5ICYmICFpc0FjdGlvbkJ1dHRvbkNsaWNrKSB8fFxuICAgICAgICAgIGlzTmF2aWdhdGluZ1xuICAgICAgICApIHtcbiAgICAgICAgICBsZWF2ZVRhYmxlRm9jdXMoKTtcblxuICAgICAgICAgIGNvbnN0IG9wZW5SZWNvcmRJbiA9IHNuYXBzaG90XG4gICAgICAgICAgICAuZ2V0TG9hZGFibGUocmVjb3JkSW5kZXhPcGVuUmVjb3JkSW5TdGF0ZSlcbiAgICAgICAgICAgIC5nZXRWYWx1ZSgpO1xuXG4gICAgICAgICAgaWYgKG9wZW5SZWNvcmRJbiA9PT0gVmlld09wZW5SZWNvcmRJblR5cGUuUkVDT1JEX1BBR0UpIHtcbiAgICAgICAgICAgIG5hdmlnYXRlKGluZGV4SWRlbnRpZmllclVybChyZWNvcmRJZCkpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGlmIChvcGVuUmVjb3JkSW4gPT09IFZpZXdPcGVuUmVjb3JkSW5UeXBlLlNJREVfUEFORUwpIHtcbiAgICAgICAgICAgIG9wZW5SZWNvcmRJbkNvbW1hbmRNZW51KHtcbiAgICAgICAgICAgICAgcmVjb3JkSWQsXG4gICAgICAgICAgICAgIG9iamVjdE5hbWVTaW5ndWxhcixcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChpc0ZpcnN0Q29sdW1uQ2VsbCAmJiAhaXNFbXB0eSAmJiBpc0FjdGlvbkJ1dHRvbkNsaWNrKSB7XG4gICAgICAgICAgbGVhdmVUYWJsZUZvY3VzKCk7XG4gICAgICAgICAgc2V0Vmlld2FibGVSZWNvcmRJZChyZWNvcmRJZCk7XG4gICAgICAgICAgc2V0Vmlld2FibGVSZWNvcmROYW1lU2luZ3VsYXIob2JqZWN0TmFtZVNpbmd1bGFyKTtcblxuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHNldERyYWdTZWxlY3Rpb25TdGFydEVuYWJsZWQoZmFsc2UpO1xuXG4gICAgICAgIG9wZW5GaWVsZElucHV0KHtcbiAgICAgICAgICBmaWVsZERlZmluaXRpb24sXG4gICAgICAgICAgcmVjb3JkSWQsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIG1vdmVFZGl0TW9kZVRvVGFibGVDZWxsUG9zaXRpb24oY2VsbFBvc2l0aW9uKTtcblxuICAgICAgICBpbml0RHJhZnRWYWx1ZSh7XG4gICAgICAgICAgdmFsdWU6IGluaXRpYWxWYWx1ZSxcbiAgICAgICAgICByZWNvcmRJZCxcbiAgICAgICAgICBmaWVsZERlZmluaXRpb24sXG4gICAgICAgICAgZmllbGRDb21wb25lbnRJbnN0YW5jZUlkOiBnZXRSZWNvcmRGaWVsZElucHV0SWQoXG4gICAgICAgICAgICByZWNvcmRJZCxcbiAgICAgICAgICAgIGZpZWxkRGVmaW5pdGlvbi5tZXRhZGF0YS5maWVsZE5hbWUsXG4gICAgICAgICAgICAncmVjb3JkLXRhYmxlLWNlbGwnLFxuICAgICAgICAgICksXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRvZ2dsZUNsaWNrT3V0c2lkZUxpc3RlbmVyKGZhbHNlKTtcblxuICAgICAgICBpZiAoaXNEZWZpbmVkKGN1c3RvbUNlbGxIb3RrZXlTY29wZSkpIHtcbiAgICAgICAgICBzZXRIb3RrZXlTY29wZShcbiAgICAgICAgICAgIGN1c3RvbUNlbGxIb3RrZXlTY29wZS5zY29wZSxcbiAgICAgICAgICAgIGN1c3RvbUNlbGxIb3RrZXlTY29wZS5jdXN0b21TY29wZXMsXG4gICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBzZXRIb3RrZXlTY29wZShcbiAgICAgICAgICAgIERFRkFVTFRfQ0VMTF9TQ09QRS5zY29wZSxcbiAgICAgICAgICAgIERFRkFVTFRfQ0VMTF9TQ09QRS5jdXN0b21TY29wZXMsXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHNldEFjdGl2ZURyb3Bkb3duRm9jdXNJZEFuZE1lbW9yaXplUHJldmlvdXMoXG4gICAgICAgICAgZ2V0RHJvcGRvd25Gb2N1c0lkRm9yUmVjb3JkRmllbGQoXG4gICAgICAgICAgICByZWNvcmRJZCxcbiAgICAgICAgICAgIGZpZWxkRGVmaW5pdGlvbi5maWVsZE1ldGFkYXRhSWQsXG4gICAgICAgICAgICAndGFibGUtY2VsbCcsXG4gICAgICAgICAgKSxcbiAgICAgICAgKTtcbiAgICAgIH0sXG4gICAgW1xuICAgICAgZ2V0Q2xpY2tPdXRzaWRlTGlzdGVuZXJJc0FjdGl2YXRlZFN0YXRlLFxuICAgICAgc2V0RHJhZ1NlbGVjdGlvblN0YXJ0RW5hYmxlZCxcbiAgICAgIG9wZW5GaWVsZElucHV0LFxuICAgICAgbW92ZUVkaXRNb2RlVG9UYWJsZUNlbGxQb3NpdGlvbixcbiAgICAgIGluaXREcmFmdFZhbHVlLFxuICAgICAgdG9nZ2xlQ2xpY2tPdXRzaWRlTGlzdGVuZXIsXG4gICAgICBzZXRBY3RpdmVEcm9wZG93bkZvY3VzSWRBbmRNZW1vcml6ZVByZXZpb3VzLFxuICAgICAgbGVhdmVUYWJsZUZvY3VzLFxuICAgICAgbmF2aWdhdGUsXG4gICAgICBpbmRleElkZW50aWZpZXJVcmwsXG4gICAgICBvcGVuUmVjb3JkSW5Db21tYW5kTWVudSxcbiAgICAgIHNldFZpZXdhYmxlUmVjb3JkSWQsXG4gICAgICBzZXRWaWV3YWJsZVJlY29yZE5hbWVTaW5ndWxhcixcbiAgICAgIHNldEhvdGtleVNjb3BlLFxuICAgIF0sXG4gICk7XG5cbiAgcmV0dXJuIHtcbiAgICBvcGVuVGFibGVDZWxsLFxuICB9O1xufTtcbiJdLCJuYW1lcyI6WyJ1c2VSZWNvaWxDYWxsYmFjayIsInVzZVNldFJlY29pbFN0YXRlIiwidXNlSW5pdERyYWZ0VmFsdWVWMiIsImlzRmllbGRWYWx1ZUVtcHR5Iiwidmlld2FibGVSZWNvcmRJZFN0YXRlIiwicmVjb3JkU3RvcmVGYW1pbHlTZWxlY3RvciIsIlNPRlRfRk9DVVNfQ0xJQ0tfT1VUU0lERV9MSVNURU5FUl9JRCIsInVzZUxlYXZlVGFibGVGb2N1cyIsInVzZU1vdmVFZGl0TW9kZVRvVGFibGVDZWxsUG9zaXRpb24iLCJ1c2VEcmFnU2VsZWN0IiwidXNlU2V0SG90a2V5U2NvcGUiLCJ1c2VDbGlja091dHNpZGVMaXN0ZW5lciIsImdldFNuYXBzaG90VmFsdWUiLCJ1c2VPcGVuUmVjb3JkSW5Db21tYW5kTWVudSIsInVzZU9wZW5GaWVsZElucHV0RWRpdE1vZGUiLCJ1c2VSZWNvcmRJbmRleENvbnRleHRPclRocm93IiwicmVjb3JkSW5kZXhPcGVuUmVjb3JkSW5TdGF0ZSIsInZpZXdhYmxlUmVjb3JkTmFtZVNpbmd1bGFyU3RhdGUiLCJSRUNPUkRfVEFCTEVfQ0xJQ0tfT1VUU0lERV9MSVNURU5FUl9JRCIsImdldERyb3Bkb3duRm9jdXNJZEZvclJlY29yZEZpZWxkIiwiZ2V0UmVjb3JkRmllbGRJbnB1dElkIiwidXNlU2V0QWN0aXZlRHJvcGRvd25Gb2N1c0lkQW5kTWVtb3JpemVQcmV2aW91cyIsInVzZUNsaWNrT3VzdGlkZUxpc3RlbmVyU3RhdGVzIiwiVmlld09wZW5SZWNvcmRJblR5cGUiLCJ1c2VOYXZpZ2F0ZSIsImlzRGVmaW5lZCIsIlRhYmxlSG90a2V5U2NvcGUiLCJERUZBVUxUX0NFTExfU0NPUEUiLCJzY29wZSIsIkNlbGxFZGl0TW9kZSIsInVzZU9wZW5SZWNvcmRUYWJsZUNlbGxWMiIsInRhYmxlU2NvcGVJZCIsImdldENsaWNrT3V0c2lkZUxpc3RlbmVySXNBY3RpdmF0ZWRTdGF0ZSIsImluZGV4SWRlbnRpZmllclVybCIsIm1vdmVFZGl0TW9kZVRvVGFibGVDZWxsUG9zaXRpb24iLCJzZXRIb3RrZXlTY29wZSIsInNldERyYWdTZWxlY3Rpb25TdGFydEVuYWJsZWQiLCJsZWF2ZVRhYmxlRm9jdXMiLCJ0b2dnbGVDbGlja091dHNpZGVMaXN0ZW5lciIsImluaXREcmFmdFZhbHVlIiwic2V0Vmlld2FibGVSZWNvcmRJZCIsInNldFZpZXdhYmxlUmVjb3JkTmFtZVNpbmd1bGFyIiwibmF2aWdhdGUiLCJzZXRBY3RpdmVEcm9wZG93bkZvY3VzSWRBbmRNZW1vcml6ZVByZXZpb3VzIiwib3BlblJlY29yZEluQ29tbWFuZE1lbnUiLCJvcGVuRmllbGRJbnB1dCIsIm9wZW5UYWJsZUNlbGwiLCJzbmFwc2hvdCIsInNldCIsImluaXRpYWxWYWx1ZSIsImNlbGxQb3NpdGlvbiIsImlzUmVhZE9ubHkiLCJvYmplY3ROYW1lU2luZ3VsYXIiLCJjdXN0b21DZWxsSG90a2V5U2NvcGUiLCJmaWVsZERlZmluaXRpb24iLCJyZWNvcmRJZCIsImlzQWN0aW9uQnV0dG9uQ2xpY2siLCJpc05hdmlnYXRpbmciLCJpc0ZpcnN0Q29sdW1uQ2VsbCIsImNvbHVtbiIsImZpZWxkVmFsdWUiLCJmaWVsZE5hbWUiLCJtZXRhZGF0YSIsImlzRW1wdHkiLCJvcGVuUmVjb3JkSW4iLCJnZXRMb2FkYWJsZSIsImdldFZhbHVlIiwiUkVDT1JEX1BBR0UiLCJTSURFX1BBTkVMIiwidmFsdWUiLCJmaWVsZENvbXBvbmVudEluc3RhbmNlSWQiLCJjdXN0b21TY29wZXMiLCJmaWVsZE1ldGFkYXRhSWQiXSwibWFwcGluZ3MiOiJBQUFBLFNBQVNBLGlCQUFpQixFQUFFQyxpQkFBaUIsUUFBUSxTQUFTO0FBRTlELFNBQVNDLG1CQUFtQixRQUFRLHlEQUF5RDtBQUc3RixTQUFTQyxpQkFBaUIsUUFBUSx1REFBdUQ7QUFDekYsU0FBU0MscUJBQXFCLFFBQVEsbUVBQW1FO0FBQ3pHLFNBQVNDLHlCQUF5QixRQUFRLDBFQUEwRTtBQUNwSCxTQUFTQyxvQ0FBb0MsUUFBUSx5RUFBeUU7QUFDOUgsU0FBU0Msa0JBQWtCLFFBQVEsaUVBQWlFO0FBQ3BHLFNBQVNDLGtDQUFrQyxRQUFRLDRFQUE0RTtBQUUvSCxTQUFTQyxhQUFhLFFBQVEsaURBQWlEO0FBQy9FLFNBQVNDLGlCQUFpQixRQUFRLGdEQUFnRDtBQUVsRixTQUFTQyx1QkFBdUIsUUFBUSw2REFBNkQ7QUFDckcs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